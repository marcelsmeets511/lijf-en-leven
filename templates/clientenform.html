{% extends "base.html" %}
{% block main %}
<h2>Clienten bewerken</h2>

<!-- SWITCH -->
<div style="margin-bottom:1rem">
  <a class="btn" href="{{ url_for('clientenbewerken', mode='form') }}">Formulier-weergave</a>
  <a class="btn" href="{{ url_for('clientenbewerken', mode='table', page=1) }}">Tabel-weergave</a>
</div>

<!-- FORMULIER MODE -->
{% if mode == "form" %}
<div class="form-grid">
  <label>ID</label><input id="id" readonly>
  <label>Achternaam</label><input id="naam_client" onfocus="setZoekVeld('naam_client')">
  <label>Straat</label><input id="straatnaam" onfocus="setZoekVeld('straatnaam')">
  <label>Postcode</label><input id="postcode" onfocus="setZoekVeld('postcode')">
  <label>Woonplaats</label><input id="woonplaats" onfocus="setZoekVeld('woonplaats')">
  <label>Email</label><input id="emailadres" onfocus="setZoekVeld('emailadres')">
  <label>Klant-ID</label><input id="klant_id" onfocus="setZoekVeld('klant_id')">
</div>

<button onclick="zoek()">Zoeken</button>
<button onclick="opslaan()">Opslaan</button>
<button onclick="verwijderen()">Verwijderen</button>
<button onclick="nieuwRecord()">Nieuw record</button>
<br>
<button onclick="eerste()">Eerste</button>
<button onclick="vorige()">Vorige</button>
<input id="recordnr" type="number" onchange="gaNaarRecord()">
<button onclick="volgende()">Volgende</button>
<button onclick="laatste()">Laatste</button>

<script>
  let records = [], huidigeIdx = 0, zoekVeld = "naam_client";
  let isNew = false; // <-- nieuw flag

  function setZoekVeld(v){ zoekVeld = v; }

  async function laadRecords(){
    const resp = await fetch("/api/records/clienten");
    records = await resp.json();
    if(records.length) toonRecord(0);
  }

  function toonRecord(idx){
    if(!records.length) return;
    const r = records[idx];
    huidigeIdx = idx;
    document.getElementById("recordnr").value = idx + 1;
    for(const[k,v] of Object.entries(r))
      if(document.getElementById(k)) document.getElementById(k).value = v ?? "";
    isNew = false; // bestaand record
  }

  // ---------- NIEUW RECORD ----------
  async function nieuwRecord(){
    // Leegmaken + nieuw klant_id
    document.querySelectorAll("input[id]").forEach(inp => inp.value = "");
    document.getElementById("id").value = ""; // geen id = insert
    isNew = true;

    // Haal hoogste klant_id op en verhoog met 1
    const resp = await fetch("/api/records/clienten");
    const data = await resp.json();
    const maxId = data.reduce((max, r) => {
      const val = parseInt(r.klant_id || 0);
      return val > max ? val : max;
    }, 0);
    document.getElementById("klant_id").value = maxId + 1;

    document.getElementById("naam_client").focus();
  }

  // ---------- OPSLAAN ----------
  async function opslaan(){
    const data = {};
    document.querySelectorAll("input[id]").forEach(inp => data[inp.id] = inp.value);

    // Als isNew = true -> insert, anders update
    const url = isNew ? "/api/opslaan/clienten" : "/api/opslaan/clienten";
    const resp = await fetch(url, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(data)
    });
    const updated = await resp.json();

    if (isNew) {
      records.push(updated);
      huidigeIdx = records.length - 1;
      isNew = false;
      alert("Nieuw record opgeslagen");
    } else {
      records[huidigeIdx] = updated;
      alert("Record opgeslagen");
    }
  }

  // ---------- REST VAN DE FUNCTIES ----------
  async function zoek(){
    const waarde = document.getElementById(zoekVeld).value;
    const resp = await fetch("/api/zoek/clienten",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({veld: zoekVeld, waarde})
    });
    records = await resp.json();
    if(records.length) toonRecord(0);
  }

  async function verwijderen(){
    if(!confirm("Record definitief verwijderen?")) return;
    const id = document.getElementById("id").value;
    if(!id) return alert("Geen record geselecteerd");
    await fetch("/api/verwijder/clienten",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({id})
    });
    records.splice(huidigeIdx,1);
    if(records.length) toonRecord(Math.min(huidigeIdx, records.length-1));
    else document.querySelector(".form-grid").reset();
    alert("Verwijderd");
  }

  function eerste(){toonRecord(0);}
  function vorige(){if(huidigeIdx>0)toonRecord(huidigeIdx-1);}
  function volgende(){if(huidigeIdx<records.length-1)toonRecord(huidigeIdx+1);}
  function laatste(){toonRecord(records.length-1);}
  function gaNaarRecord(){
    const nr = parseInt(document.getElementById("recordnr").value) - 1;
    if(nr>=0 && nr<records.length) toonRecord(nr);
  }

  laadRecords();
</script>

<!-- TABEL MODE – BEWERKBARE GRID -->
{% else %}
<div style="margin-bottom:1rem">
  <input id="zoekText" placeholder="Zoeken op naam…">
  <button onclick="zoekInTabel()">Zoeken</button>
  <button onclick="nieuwRecord()">Nieuw</button>
  <button onclick="opslaanTabel()">Opslaan</button>
  <button onclick="verwijderenTabel()">Verwijderen</button>
</div>

<table class="table table-bordered" style="width:100%">
  <thead>
    <tr>
      <th>ID</th>
      <th>Achternaam</th>
      <th>Straat</th>
      <th>Postcode</th>
      <th>Woonplaats</th>
      <th>Email</th>
      <th>Klant-ID</th>
    </tr>
  </thead>
  <tbody id="tableBody">
    {% for r in records %}
    <tr data-id="{{ r.id }}">
      <td><input type="text" value="{{ r.id }}" readonly style="width:100%"></td>
      <td><input type="text" value="{{ r.naam_client }}" style="width:100%"></td>
      <td><input type="text" value="{{ r.straatnaam }}" style="width:100%"></td>
      <td><input type="text" value="{{ r.postcode }}" style="width:100%"></td>
      <td><input type="text" value="{{ r.woonplaats }}" style="width:100%"></td>
      <td><input type="text" value="{{ r.emailadres }}" style="width:100%"></td>
      <td><input type="text" value="{{ r.klant_id }}" style="width:100%"></td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<nav>
  {% if page > 1 %}
    <a class="btn" href="{{ url_for('clientenbewerken', mode='table', page=page-1) }}">Vorige</a>
  {% endif %}
  <span>Pagina {{ page }} van {{ pages }}</span>
  {% if page < pages %}
    <a class="btn" href="{{ url_for('clientenbewerken', mode='table', page=page+1) }}">Volgende</a>
  {% endif %}
</nav>

<script>
  // ---------- BEWERKEN VANUIT TABEL ----------
  function nieuwRecord(){
    const tbody = document.getElementById("tableBody");
    const newRow = tbody.insertRow();
    newRow.innerHTML = `
      <td><input value="" readonly style="width:100%"></td>
      <td><input value="" style="width:100%"></td>
      <td><input value="" style="width:100%"></td>
      <td><input value="" style="width:100%"></td>
      <td><input value="" style="width:100%"></td>
      <td><input value="" style="width:100%"></td>
      <td><input value="" style="width:100%"></td>`;
    newRow.querySelector("td:nth-child(2) input").focus();
  }

  async function opslaanTabel(){
    const rows = document.querySelectorAll("#tableBody tr");
    for(const tr of rows){
      const inputs = tr.querySelectorAll("input");
      const data = {
        id: inputs[0].value || None,
        naam_client: inputs[1].value,
        straatnaam: inputs[2].value,
        postcode: inputs[3].value,
        woonplaats: inputs[4].value,
        emailadres: inputs[5].value,
        klant_id: inputs[6].value
      };
      await fetch("/api/opslaan/clienten",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify(data)
      });
    }
    alert("Alle wijzigingen opgeslagen");
    location.reload();          // herlaadt huidige pagina
  }

  async function verwijderenTabel(){
    const sel = document.querySelector("tr:focus");
    if(!sel && !confirm("Weet je zeker dat je de actieve rij(en) wilt verwijderen?")) return;
    const rows = sel ? [sel] : Array.from(document.querySelectorAll("#tableBody tr"));
    for(const tr of rows){
      const id = tr.querySelector("input").value;
      if(id){
        await fetch("/api/verwijder/clienten",{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({id})
        });
        tr.remove();
      }
    }
    alert("Verwijderd");
  }

  async function zoekInTabel(){
    const q = document.getElementById("zoekText").value;
    const resp = await fetch("/api/zoek/clienten",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({veld:"naam_client", waarde:q})
    });
    const data = await resp.json();
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";
    data.forEach(r=>{
      const tr = tbody.insertRow();
      tr.innerHTML = `
        <td><input value="${r.id}" readonly style="width:100%"></td>
        <td><input value="${r.naam_client}" style="width:100%"></td>
        <td><input value="${r.straatnaam}" style="width:100%"></td>
        <td><input value="${r.postcode}" style="width:100%"></td>
        <td><input value="${r.woonplaats}" style="width:100%"></td>
        <td><input value="${r.emailadres}" style="width:100%"></td>
        <td><input value="${r.klant_id}" style="width:100%"></td>`;
    });
  }
</script>
{% endif %}
{% endblock %}