{% extends "base.html" %}
{% block main %}
<h2>Overzicht bewerken</h2>

<!-- SWITCH -->
<div style="margin-bottom:1rem">
  <a class="btn" href="{{ url_for('overzichtbewerken', mode='form') }}">Formulier-weergave</a>
  <a class="btn" href="{{ url_for('overzichtbewerken', mode='table', page=1) }}">Tabel-weergave</a>
</div>

<!-- FORMULIER MODE -->
{% if mode == "form" %}
<div class="form-grid">
  <label>ID</label><input id="id" readonly>
  <label>Datum</label><input id="datum_dienst" type="date" onfocus="setZoekVeld('datum_dienst')">
  <label>Naam</label><input id="naam" onfocus="setZoekVeld('naam')">
  <label>Tijd</label><input id="tijd" type="time">
  <label>Contant</label><select id="contant"><option value="true">Ja</option><option value="false">Nee</option></select>
  <label>Te ontvangen</label><input id="te_ontvangen" type="number" step="0.01">
  <label>Opmerking</label><input id="opmerking">
  <label>Bedrag</label><input id="bedrag" type="number" step="0.01">
  <label>Factuurnr</label><input id="factuurnummer">
  <label>Debiteurnr</label><input id="deb_nr">
</div>

<button onclick="zoek()">Zoeken</button>
<button onclick="opslaan()">Opslaan</button>
<button onclick="verwijderen()">Verwijderen</button>
<br>
<button onclick="eerste()">Eerste</button>
<button onclick="vorige()">Vorige</button>
<input id="recordnr" type="number" onchange="gaNaarRecord()">
<button onclick="volgende()">Volgende</button>
<button onclick="laatste()">Laatste</button>

<script>
  let records = [], huidigeIdx = 0, zoekVeld = "naam";
  function setZoekVeld(v){ zoekVeld = v; }
  async function laadRecords(){
    const resp = await fetch("/api/records/overzicht");
    records = await resp.json();
    if(records.length) toonRecord(0);
  }
  function toonRecord(idx){
    if(!records.length) return;
    const r = records[idx];
    huidigeIdx = idx;
    document.getElementById("recordnr").value = idx + 1;
    for(const[k,v] of Object.entries(r)){
      const el = document.getElementById(k);
      if(el) el.value = v ?? "";
    }
  }
  async function zoek(){
    const waarde = document.getElementById(zoekVeld).value;
    const resp = await fetch("/api/zoek/overzicht",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({veld: zoekVeld, waarde})
    });
    records = await resp.json();
    if(records.length) toonRecord(0);
  }
  async function opslaan(){
    const data = {};
    document.querySelectorAll("input[id],select[id]").forEach(inp=> data[inp.id] = inp.value);
    data.contant = data.contant === "true";
    const resp = await fetch("/api/opslaan/overzicht",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(data)
    });
    const updated = await resp.json();
    records[huidigeIdx] = updated;
    alert("Opgeslagen");
  }
  async function verwijderen(){
    if(!confirm("Record definitief verwijderen?")) return;
    const id = document.getElementById("id").value;
    await fetch("/api/verwijder/overzicht",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({id})
    });
    records.splice(huidigeIdx,1);
    if(records.length) toonRecord(Math.min(huidigeIdx, records.length-1));
    else document.querySelector(".form-grid").reset();
    alert("Verwijderd");
  }
  function eerste(){toonRecord(0);}
  function vorige(){if(huidigeIdx>0)toonRecord(huidigeIdx-1);}
  function volgende(){if(huidigeIdx<records.length-1)toonRecord(huidigeIdx+1);}
  function laatste(){toonRecord(records.length-1);}
  function gaNaarRecord(){
    const nr = parseInt(document.getElementById("recordnr").value) - 1;
    if(nr>=0 && nr<records.length) toonRecord(nr);
  }
  laadRecords();
</script>

<!-- TABEL MODE – BEWERKBARE GRID -->
{% else %}
<div style="margin-bottom:1rem">
  <input id="zoekText" placeholder="Zoeken op naam…">
  <button onclick="zoekInTabel()">Zoeken</button>
  <button onclick="nieuwRecord()">Nieuw</button>
  <button onclick="opslaanTabel()">Opslaan</button>
  <button onclick="verwijderenTabel()">Verwijderen</button>
</div>

<table class="table table-bordered" style="width:100%">
  <thead>
    <tr>
      <th>ID</th>
      <th>Datum</th>
      <th>Naam</th>
      <th>Tijd</th>
      <th>Contant</th>
      <th>Te ontvangen</th>
      <th>Opmerking</th>
      <th>Bedrag</th>
      <th>Factuurnr</th>
      <th>Debiteurnr</th>
    </tr>
  </thead>
  <tbody id="tableBody">
    {% for r in records %}
    <tr data-id="{{ r.id }}">
      <td><input type="text" value="{{ r.id }}" readonly style="width:100%"></td>
      <td><input type="date" value="{{ r.datum_dienst }}" style="width:100%"></td>
      <td><input type="text" value="{{ r.naam }}" style="width:100%"></td>
      <td><input type="time" value="{{ r.tijd }}" style="width:100%"></td>
      <td>
        <select style="width:100%">
          <option value="true" {% if r.contant %}selected{% endif %}>Ja</option>
          <option value="false" {% if not r.contant %}selected{% endif %}>Nee</option>
        </select>
      </td>
      <td><input type="number" step="0.01" value="{{ r.te_ontvangen }}" style="width:100%"></td>
      <td><input type="text" value="{{ r.opmerking }}" style="width:100%"></td>
      <td><input type="number" step="0.01" value="{{ r.bedrag }}" style="width:100%"></td>
      <td><input type="text" value="{{ r.factuurnummer }}" style="width:100%"></td>
      <td><input type="text" value="{{ r.deb_nr }}" style="width:100%"></td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<nav>
  {% if page > 1 %}
    <a class="btn" href="{{ url_for('overzichtbewerken', mode='table', page=page-1) }}">Vorige</a>
  {% endif %}
  <span>Pagina {{ page }} van {{ pages }}</span>
  {% if page < pages %}
    <a class="btn" href="{{ url_for('overzichtbewerken', mode='table', page=page+1) }}">Volgende</a>
  {% endif %}
</nav>

<script>
  function nieuwRecord(){
    const tbody = document.getElementById("tableBody");
    const newRow = tbody.insertRow();
    newRow.innerHTML = `
      <td><input value="" readonly style="width:100%"></td>
      <td><input type="date" value="" style="width:100%"></td>
      <td><input value="" style="width:100%"></td>
      <td><input type="time" value="" style="width:100%"></td>
      <td><select style="width:100%"><option value="true">Ja</option><option value="false">Nee</option></select></td>
      <td><input type="number" step="0.01" value="" style="width:100%"></td>
      <td><input value="" style="width:100%"></td>
      <td><input type="number" step="0.01" value="" style="width:100%"></td>
      <td><input value="" style="width:100%"></td>
      <td><input value="" style="width:100%"></td>`;
    newRow.querySelector("td:nth-child(3) input").focus();
  }

  async function opslaanTabel(){
    const rows = document.querySelectorAll("#tableBody tr");
    for(const tr of rows){
      const inputs = tr.querySelectorAll("input");
      const selects = tr.querySelectorAll("select");
      const data = {
        id: inputs[0].value || null,
        datum_dienst: inputs[1].value,
        naam: inputs[2].value,
        tijd: inputs[3].value,
        contant: selects[0].value === "true",
        te_ontvangen: parseFloat(inputs[4].value),
        opmerking: inputs[5].value,
        bedrag: parseFloat(inputs[6].value),
        factuurnummer: inputs[7].value,
        deb_nr: inputs[8].value
      };
      await fetch("/api/opslaan/overzicht",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify(data)
      });
    }
    alert("Alle wijzigingen opgeslagen");
    location.reload();
  }

  async function verwijderenTabel(){
    const rows = document.querySelectorAll("#tableBody tr");
    for(const tr of rows){
      const id = tr.querySelector("input").value;
      if(id){
        await fetch("/api/verwijder/overzicht",{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({id})
        });
        tr.remove();
      }
    }
    alert("Verwijderd");
  }

  async function zoekInTabel(){
    const q = document.getElementById("zoekText").value;
    const resp = await fetch("/api/zoek/overzicht",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({veld:"naam", waarde:q})
    });
    const data = await resp.json();
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";
    data.forEach(r=>{
      const tr = tbody.insertRow();
      tr.innerHTML = `
        <td><input value="${r.id}" readonly style="width:100%"></td>
        <td><input type="date" value="${r.datum_dienst}" style="width:100%"></td>
        <td><input value="${r.naam}" style="width:100%"></td>
        <td><input type="time" value="${r.tijd}" style="width:100%"></td>
        <td><select style="width:100%"><option value="true" ${r.contant?"selected":""}>Ja</option><option value="false" ${!r.contant?"selected":""}>Nee</option></select></td>
        <td><input type="number" step="0.01" value="${r.te_ontvangen}" style="width:100%"></td>
        <td><input value="${r.opmerking}" style="width:100%"></td>
        <td><input type="number" step="0.01" value="${r.bedrag}" style="width:100%"></td>
        <td><input value="${r.factuurnummer}" style="width:100%"></td>
        <td><input value="${r.deb_nr}" style="width:100%"></td>`;
    });
  }
</script>
{% endif %}
{% endblock %}